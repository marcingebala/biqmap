var canvas={scale:100,width_canvas:700,height_canvas:400,canvas:null,context:null,thumbnail:null,title_project:"nowy projekt",context_x:0,context_y:0,context_new_x:0,context_new_y:0,offset_left:null,offset_top:null,active_row:null,active_column:null,thumbnail:function(){var a=document.getElementById("main_canvas"),e=a.toDataURL();console.log(e)},draw:function(){this.clear(),pointers.create_array(),pointers.draw(),void 0!==image.obj&&image.draw()},draw_thumnail:function(){canvas.canvas=document.getElementById("thumbnail_canvas"),canvas.thumbnail=document.getElementById("thumbnail_canvas"),canvas.context=canvas.canvas.getContext("2d"),this.clear(),pointers.create_array(),pointers.draw(),canvas.canvas=document.getElementById("main_canvas"),canvas.context=canvas.canvas.getContext("2d")},reset:function(){this.context.setTransform(1,0,0,1,0,0),canvas.context.scale(canvas.scale/100,canvas.scale/100)},clear:function(){this.context.clearRect(0,0,this.width_canvas,this.height_canvas)},resize_width:function(a){this.width_canvas=a,$("#main_canvas").attr("width",this.width_canvas+"px"),$("#canvas_box, #canvas_wrapper").css({width:this.width_canvas+"px"}),$("#canvas_info #width").val(this.width_canvas+"px"),this.scale=100,$("#canvas_info #size").val(this.scale+"%"),menu_top.show_info()},resize_height:function(a){this.height_canvas=a,$("#main_canvas").attr("height",this.height_canvas+"px"),$("#canvas_box, #canvas_wrapper").css({height:this.height_canvas+"px"}),$("#canvas_info #height").val(this.height_canvas+"px"),this.scale=100,$("#canvas_info #size").val(this.scale+"%"),menu_top.show_info()},set_default:function(){$("#canvas_box #right_resize, #canvas_box #bottom_resize").fadeIn(500),this.move_image&&$("#canvas_box #image_resize").fadeIn(0),canvas.scale=100,canvas.context_x=0,canvas.context_y=0,canvas.context.scale(canvas.scale/100,canvas.scale/100);var a=canvas.width_canvas*(canvas.scale/100),e=canvas.height_canvas*(canvas.scale/100);$("#main_canvas").attr({width:a+"px",height:e+"px"}),$("#canvas_box, #canvas_wrapper").css({width:a+"px",height:e+"px"}),canvas.reset(),canvas.context.translate(canvas.context_x/(canvas.scale/100),canvas.context_y/(canvas.scale/100)),menu_top.show_info()}},categories={};cloud={set_textarea:function(){$("#cloud .cloud_text").val(layers.cloud[layers.active])},set_position:function(){var a=mouse.left-on_category.canvas_offset_left,e=mouse.top-on_category.canvas_offset_top,t=$("#canvas_cloud").width();a+t>$("body").width()-20&&(a=a-t-20),$("#canvas_cloud").css({top:parseInt(e-$("#canvas_cloud").height())+"px",left:a+"px"})},update_text:function(a){if(""!=a&&"null"!=a){for(var e=0,t=0,n=excel.data.length;t<n;t++)if(String(a).toLowerCase()==String(excel.data[t][layers.category[layers.active]]).toLowerCase()){this.set_position();for(var s=layers.cloud[layers.active],o=0,c=excel.data[0].length;o<c;o++)s=s.replace("{"+excel.data[0][o]+"}",excel.data[t][o]);""!=s&&null!=excel.data[t][layers.value[layers.active]]&&($("#canvas_cloud").fadeIn(0),$("#canvas_cloud").html(s),e=1)}e||$("#canvas_cloud").fadeOut(0)}else $("#canvas_cloud").fadeOut(0)}},crud={map_json:Array(),map_hash:null,layers:{},excel:Array(),project:{},project_hash:project_hash,set_map:function(a){this.map_json=a,canvas.height_canvas=a[0][0],canvas.width_canvas=a[0][1],pointers.padding_x=a[0][2],pointers.padding_y=a[0][3],pointers.translate_modulo=a[0][4],pointers.size=a[0][5],pointers.main_kind=a[0][6],canvas.title_project=a[0][7],$('#pointer_box input[name="padding_x"]').val(a[0][2]),$('#pointer_box input[name="padding_y"]').val(a[0][3]),$('#pointer_box input[name="size_pointer"]').val(a[0][5]),$('input[name="title_project"]').val(a[0][7]),a[0][4]&&($('#pointer_box div[name="translate_modulo"]').removeClass("switch-off"),$('#pointer_box div[name="translate_modulo"]').addClass("switch-on")),$('#pointer_box select[name="main_kind"]').html(""),pointers.kinds.forEach(function(e){e==a[0][6]?$('#pointer_box select[name="main_kind"]').append('<option selected="selected" name="'+e+'">'+e+"</option>"):$('#pointer_box select[name="main_kind"]').append('<option name="'+e+'">'+e+"</option>")}),pointers.pointers=a[1];var e={};e.category=a[2],layers.category_colors[0]=[],layers.category_name=[];for(var t=0,n=e.category.length;t<n;t++)layers.category_name.push(e.category[t][0]),layers.category_colors[0].push(e.category[t][1]);a[3].length>2&&(image.obj=new Image,image.obj.src=a[3][0],image.x=parseInt(a[3][1]),image.y=parseInt(a[3][2]),image.width=parseInt(a[3][3]),image.height=parseInt(a[3][4]),image.alpha=parseInt(a[3][5]),$('#alpha_image option[name="'+image.alpha+'"]').attr("selected",!0),image.obj.onload=function(){canvas.draw()}),$("#main_canvas").attr("width",canvas.width_canvas+"px"),$("#main_canvas").attr("height",canvas.height_canvas+"px"),$("#canvas_box, #canvas_wrapper").css({width:canvas.width_canvas+"px",height:canvas.height_canvas+"px"})},set_project:function(a){this.set_map(JSON.parse(a.map_json)),excel.data=JSON.parse(a.excel),a.project=JSON.parse(a.project),a.layers=JSON.parse(a.layers),layers.palets_active=a.layers.palets_active,layers.value=a.layers.value,layers.colors_pos=a.layers.colors_pos,layers.colors_active=a.layers.colors_active,layers.min_value=a.layers.min_value,layers.max_value=a.layers.max_value,layers.cloud=a.layers.cloud,layers.cloud_parser=a.layers.cloud_parser,layers.legends=a.layers.legends,layers.labels=a.layers.labels,layers.category=a.layers.category,layers.category_colors=a.layers.category_colors,layers.category_name=a.layers.category_name,layers.list=a.layers.list,layers.project_name=a.project.name,layers.source=a.project.source,$('input[name="project_name"]').val(layers.project_name),legends.show(),labels.show(),layers.show(),source.show();var e=$("#canvas_box").offset();canvas.offset_left=e.left,canvas.offset_top=e.top},get_project:function(){$.ajax({url:"/api/project/"+crud.project_hash,type:"GET",contentType:"application/json"}).done(function(a){crud.set_project(a.data)})}};var excel={},figures={square:function(a,e,t){canvas.context.fillRect(a,e,t,t)},circle:function(a,e,t){var t=t/2,n=a+t,s=e+t;canvas.context.beginPath(),canvas.context.arc(n,s,t,0,2*Math.PI),canvas.context.fill()},hexagon:function(a,e,t){var n=t/4,s=t/2,o=t/2*Math.sqrt(3)/2;canvas.context.beginPath(),canvas.context.moveTo(a,e+s),canvas.context.lineTo(a+n,e+s-o),canvas.context.lineTo(a+n+s,e+s-o),canvas.context.lineTo(a+t,e+s),canvas.context.lineTo(a+t-n,e+s+o),canvas.context.lineTo(a+n,e+s+o),canvas.context.lineTo(a,e+s),canvas.context.fill()},hexagon2:function(a,e,t){var n=t/4,s=t/2,o=t/2*Math.sqrt(3)/2;canvas.context.beginPath(),canvas.context.moveTo(a+s,e),canvas.context.lineTo(a+s+o,e+n),canvas.context.lineTo(a+s+o,e+s+n),canvas.context.lineTo(a+s,e+t),canvas.context.lineTo(a+s-o,e+s+n),canvas.context.lineTo(a+s-o,e+n),canvas.context.lineTo(a+s,e),canvas.context.fill()}},image={obj:void 0,x:null,y:null,width:null,height:null,alpha:10,draw:function(){canvas.context.globalAlpha=this.alpha/10,canvas.context.drawImage(this.obj,this.x,this.y,this.width,this.height),$("#canvas_box #image_resize").css({height:this.height,top:this.y+"px",left:this.x+this.width+"px"}),canvas.context.globalAlpha=1},dataURItoBlob:function(a){for(var e=atob(a.split(",")[1]),t=[],n=0;n<e.length;n++)t.push(e.charCodeAt(n));return new Blob([new Uint8Array(t)],{type:"image/png"})}},data_input={get:function(){map.name=$('#map_form input[name="name"]').val(),map.path=$("#map_form textarea").val().replace(/"/g,"'"),$("#map_contener").html($("textarea[name=map_path]").val())},set:function(){$('#map_form input[name="name"]').val(map.name),$("#map_form textarea").val(map.path),$("#map_contener").html($("textarea[name=map_path]").val())}};labels={show:function(){$("#labels").html(layers.labels[layers.active])}};var layers={list:["zakładka 1"],active:0,palets_active:[0],value:[-1],colors_pos:[[1,1,1,1,1,1,1,1,1]],colors_active:[["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"]],min_value:[0],max_value:[0],cloud:[""],cloud_parser:[""],legends:[[]],labels:[""],category:[-1],category_colors:[],category_name:[],project_name:"nowy projekt",source:"",show:function(){if(this.list.length>1){var a="";a+='<span num="0" class="active">'+this.list[0]+"</span>";for(var e=1,t=this.list.length;e<t;e++)a+='<span num="'+e+'">'+this.list[e]+"</span>";$("#area").html(a),$("#area span").click(function(){layers.select(this)})}else $("#area").css("display","none")},select:function(a){$("#area span").removeClass("active"),$(a).addClass("active"),console.log(a),layers.active=$(a).index(),legends.show(),labels.show(),canvas.draw()}};legends={show:function(){for(var a="",e=0,t=layers.legends[layers.active].length;e<t;e++)a+="<div> <span style='background-color:"+layers.legends[layers.active][e][3]+"'></span><span>"+layers.legends[layers.active][e][2]+"</span></div>";$("#legends").html(a)}},$(".box > ul > li").click(function(){menu_top.change_box(this)}),$(document).ready(function(){canvas.canvas=document.getElementById("main_canvas"),canvas.context=canvas.canvas.getContext("2d"),canvas.width_canvas=parseInt($("#main_canvas").attr("width")),canvas.height_canvas=parseInt($("#main_canvas").attr("height"));var a=$("#canvas_box").offset();canvas.offset_left=a.left,canvas.offset_top=a.top,pointers.create_array(),$(document).mouseup(function(){mouse.mouse_down=!1}),$(document).mousedown(function(a){a||(a=window.event),mouse.set_mouse_down(a)}),$(document).mousemove(function(a){a||(a=window.event),mouse.set_position(a),mouse.mouse_down&&mouse.mousemove(a),menu_top.auto_draw&&(mouse.click_obj="canvas",mouse.mousemove(a))}),$("#main_canvas").mousedown(function(a){a||(a=window.event),mouse.set_mouse_down(a),mouse.set_position(a),mouse.mousemove(a)}),$(document).mouseup(function(){pointers.last_column=null,pointers.last_row=null,canvas.context_x=canvas.context_new_x,canvas.context_y=canvas.context_new_y}),crud.get_project()}),$("#canvas_wrapper").mouseleave(function(){$("#canvas_cloud").fadeOut(200)}),$("#canvas_wrapper").mousemove(function(){var a=on_category.get_name();cloud.update_text(a)}),$("#canvas_cloud").mousemove(function(){cloud.set_position()}),menu_top={move_image:!1,move_canvas:!1,auto_draw:!1,mode_key:!0,category:0,disable_select:!1,change_box:function(a){console.log(a),$(a).parent().children("li").removeClass("active"),$(a).addClass("active");var e=$(a).attr("category");$(a).parent().parent().children("div").fadeOut(500,function(){$(a).parent().parent().children("#"+e).delay(100).fadeIn(500)})},get_maps:function(){$.ajax({url:"/api/maps",type:"GET",contentType:"application/json"}).done(function(a){if("ok"==a.status){for(var e='<option id="select_map">wybierz mapę</option>',t=0,n=a.data.length;t<n;t++)e+=a.data[t]._id==crud.map_hash?'<option selected id="'+a.data[t]._id+'">'+JSON.parse(a.data[t].map_json)[0][7]+"</option>":'<option id="'+a.data[t]._id+'">'+JSON.parse(a.data[t].map_json)[0][7]+"</option>";$("#toolbar_top select.select_map").html(e),$(".select_map").change(function(){"select_map"!=$(this).find("option:selected").attr("id")&&(null!=crud.map_hash?confirm("Czy chcesz wczytać nową mapę ?")&&(crud.map_hash=$(this).find("option:selected").attr("id"),crud.get_map()):($(".select_map option").eq(0).remove(),crud.map_hash=$(this).find("option:selected").attr("id"),crud.get_map()))})}else alert("nie mogę pobrać listy map"),console.log(a)})},get_projects:function(){$.ajax({url:"/api/projects",type:"GET",contentType:"application/json"}).done(function(a){if("ok"==a.status){for(var e='<option id="new_project">nowy projekt</option>',t=0,n=a.data.length;t<n;t++)e+=a.data[t]._id==crud.project_hash?'<option selected id="'+a.data[t]._id+'">'+JSON.parse(a.data[t].project).name+"</option>":'<option id="'+a.data[t]._id+'">'+JSON.parse(a.data[t].project).name+"</option>";$("#toolbar_top select.select_project").html(e),$(".select_project").change(function(){confirm("Czy chcesz wczytać nowy projekt ?")&&("new_project"==$(this).find("option:selected").attr("id")?location.reload():(crud.project_hash=$(this).find("option:selected").attr("id"),crud.get_project()))})}else alert("nie mogę pobrać listy projektów"),console.log(a)})},update_canvas_info:function(){canvas.scale=parseInt($("#canvas_info #size").val()),canvas.width_canvas=parseInt($("#canvas_info #width").val()),canvas.height_canvas=parseInt($("#canvas_info #height").val()),$("#canvas_info #size").val(canvas.scale+"%"),$("#canvas_info #width").val(canvas.width_canvas+"px"),$("#canvas_info #height").val(canvas.height_canvas+"px"),$("#canvas_box, #canvas_wrapper").css({width:canvas.width_canvas+"px",height:canvas.height_canvas+"px"}),$("#canvas_box #main_canvas").attr("width",canvas.width_canvas+"px"),$("#canvas_box #main_canvas").attr("height",canvas.height_canvas+"px"),canvas.draw()},change_alpha:function(){image.alpha=$("#alpha_image").find("option:selected").attr("name"),canvas.draw()},add_image:function(){var a=prompt("Podaj ścieżkę do zdjęcia: ");a&&a.length>0&&(image.obj=new Image,image.obj.onload=function(){image.width=image.obj.width,image.height=image.obj.height,image.draw()},image.x=0,image.y=0,image.obj.src=a)},show_info:function(){$("#canvas_info #size").val(parseInt(canvas.scale)+"%"),$("#canvas_info #width").val(parseInt(canvas.width_canvas)+"px"),$("#canvas_info #height").val(parseInt(canvas.height_canvas)+"px")}};var mouse={mouse_down:!1,click_obj:null,tmp_mouse_x:null,tmp_mouse_y:null,left:null,top:null,padding_x:null,padding_y:null,offset_x:null,offset_y:null,set_mouse_down:function(a){a||(a=window.event);var e=a.target;if("undefined"!=typeof $(a.target).attr("nameclick")){this.click_obj=$(a.target).attr("nameclick");var t=$(e).offset();this.offset_x=t.left,this.offset_y=t.top,this.padding_x=this.left-t.left,this.padding_y=this.top-t.top,mouse.mouse_down=!0,this.tmp_mouse_x=image.x,this.tmp_mouse_y=image.y}},set_position:function(a){this.left=a.pageX,this.top=a.pageY},mousemove:function(){switch(this.click_obj){case"right_resize":var a=$("#canvas_box #canvas_wrapper").children("canvas").offset(),e=this.left-this.padding_x-a.left;e<screen.width-100&&canvas.resize_width(e),canvas.draw();break;case"bottom_resize":var a=$("#canvas_box #canvas_wrapper").children("canvas").offset();canvas.resize_height(this.top-this.padding_y-a.top),canvas.draw();break;case"image_resize":if(void 0!==image.obj){var a=$("#canvas_box #canvas_wrapper").children("canvas").offset(),t=this.left-a.left,n=image.x+image.width-t+this.padding_x,s=image.width/image.height;image.width-n>100&&(image.width-=n,image.height-=n/s,canvas.draw())}}}},on_category={canvas_offset_top:$("#canvas_wrapper").offset().top,canvas_offset_left:$("#canvas_wrapper").offset().left,get_name:function(){var a=mouse.left-canvas.offset_left,e=mouse.top-canvas.offset_top,t=Math.ceil(e/(pointers.size+pointers.padding_y));if(pointers.translate_modulo&&t%2!=0)var n=Math.ceil((a+pointers.size/2)/(pointers.size+pointers.padding_x))-1;else var n=Math.ceil(a/(pointers.size+pointers.padding_x));try{var s=pointers.pointers[t-1][n-1],o=layers.category_name[s]}catch(c){return"null"}return"pusty"==o||"gumuj"==o?"null":o}};palets={};var pointers={show_all_point:!0,padding_x:1,padding_y:1,translate_modulo:!1,size:10,main_kind:"square",kinds:Array("square","circle","hexagon","hexagon2"),pointers:Array(),last_column:null,last_row:null,draw:function(){for(var a=this.size+this.padding_x,e=this.size+this.padding_y,t="rgba(0,0,0,0)",n=0;n<canvas.active_row;n++)for(var s=0;s<canvas.active_column;s++){if(0==this.pointers[n][s])canvas.context.fillStyle=t,canvas.context.globalAlpha=.5;else{this.pointers[n][s]!=menu_top.category&&0!=menu_top.category?canvas.context.globalAlpha=.2:canvas.context.globalAlpha=1;try{canvas.context.fillStyle=layers.category_colors[layers.active][this.pointers[n][s]]}catch(o){console.log("ERROR 39 LINE ! ",this.pointers[n][s],n,s)}}n%2==0&&pointers.translate_modulo?window.figures[this.main_kind](s*a+a/2,n*e,this.size):window.figures[this.main_kind](s*a,n*e,this.size)}},create_array:function(){if(canvas.active_row=parseInt(canvas.height_canvas/(pointers.size+pointers.padding_y)),canvas.active_column=parseInt(canvas.width_canvas/(pointers.size+pointers.padding_x)),this.pointers.length<canvas.active_row||this.pointers[0].length<canvas.active_column)for(var a=0;a<canvas.active_row;a++)for(var e=0;e<canvas.active_column;e++)void 0==this.pointers[a]&&(this.pointers[a]=new Array),void 0==this.pointers[a][e]&&(this.pointers[a][e]=0)},update_point:function(a,e,t,n){if(this.pointers[a][e]=parseInt(menu_top.category),t==a&&n==e||null==t||null==n)this.pointers[a][e]=parseInt(menu_top.category);else{var s=(t-a)/(n-e),o=a-s*e;if(n>e)var c=e,i=n;else var i=e,c=n;if(t>a)var r=a,l=t;else var l=a,r=t;for(var p=null,v=c;v<=i;v++)p=parseInt(s*v+o),$.isNumeric(p)||(p=a),this.pointers[p][v]=parseInt(menu_top.category);for(var v=null,p=r;p<=l;p++)v=parseInt((p-o)/s),$.isNumeric(v)||(v=e),this.pointers[p][v]=parseInt(menu_top.category)}}},source={show:function(){$("#source").html(layers.source)}};