var canvas={scale:100,width_canvas:700,height_canvas:400,canvas:null,context:null,thumbnail:null,title_project:"nowy projekt",context_x:0,context_y:0,context_new_x:0,context_new_y:0,offset_left:null,offset_top:null,active_row:null,active_column:null,thumbnail:function(){var e=document.getElementById("main_canvas"),a=e.toDataURL();console.log(a)},draw:function(){this.clear(),pointers.create_array(),pointers.draw(),void 0!==image.obj&&image.draw()},draw_thumnail:function(){canvas.canvas=document.getElementById("thumbnail_canvas"),canvas.thumbnail=document.getElementById("thumbnail_canvas"),canvas.context=canvas.canvas.getContext("2d"),this.clear(),pointers.create_array(),pointers.draw(),canvas.canvas=document.getElementById("main_canvas"),canvas.context=canvas.canvas.getContext("2d")},reset:function(){this.context.setTransform(1,0,0,1,0,0),canvas.context.scale(canvas.scale/100,canvas.scale/100)},clear:function(){this.context.clearRect(0,0,this.width_canvas,this.height_canvas)},resize_width:function(e){this.width_canvas=e,$("#main_canvas").attr("width",this.width_canvas+"px"),$("#canvas_box, #canvas_wrapper").css({width:this.width_canvas+"px"}),$("#canvas_info #width").val(this.width_canvas+"px"),this.scale=100,$("#canvas_info #size").val(this.scale+"%"),menu_top.show_info()},resize_height:function(e){this.height_canvas=e,$("#main_canvas").attr("height",this.height_canvas+"px"),$("#canvas_box, #canvas_wrapper").css({height:this.height_canvas+"px"}),$("#canvas_info #height").val(this.height_canvas+"px"),this.scale=100,$("#canvas_info #size").val(this.scale+"%"),menu_top.show_info()},set_default:function(){$("#canvas_box #right_resize, #canvas_box #bottom_resize").fadeIn(500),this.move_image&&$("#canvas_box #image_resize").fadeIn(0),canvas.scale=100,canvas.context_x=0,canvas.context_y=0,canvas.context.scale(canvas.scale/100,canvas.scale/100);var e=canvas.width_canvas*(canvas.scale/100),a=canvas.height_canvas*(canvas.scale/100);$("#main_canvas").attr({width:e+"px",height:a+"px"}),$("#canvas_box, #canvas_wrapper").css({width:e+"px",height:a+"px"}),canvas.reset(),canvas.context.translate(canvas.context_x/(canvas.scale/100),canvas.context_y/(canvas.scale/100)),canvas.draw(),menu_top.show_info(),canvas.draw()}},categories={add:function(){var e=Array($('#category_box input[name="add_category"]').val(),"#ff0000");$('#category_box input[name="add_category"]').val(""),this.category.push(e),menu_top.category=this.category.length-1,this.show_list()},update:function(e,a){this.category[e][0]=a,this.show_list()},update_color:function(){if(crud.map_json.length>0&&excel.data.length>0&&layers.category[layers.active]!=-1&&layers.value[layers.active]!=-1)for(var e=0,a=layers.category_name.length;e<a;e++)for(var t=layers.category_name[e],s=!1,n=0,o=layers.list.length;n<o;n++){for(var c=0,r=excel.data.length;c<r;c++)if(String(excel.data[c][layers.category[n]]).toLowerCase()==String(t).toLowerCase()&&""!=excel.data[c][layers.category[n]]){s=!0;var l=String(excel.data[c][layers.value[n]]).replace(",",".");console.log(excel.data[c][layers.value[n]]+" | "+l);for(var i=0,d=layers.legends[n].length;i<d;i++)l>=layers.legends[n][i][0]&&l<=layers.legends[n][i][1]&&(layers.category_colors[n][e]=layers.legends[n][i][3],i=d,c=r);l<layers.legends[n][0][0]&&(layers.category_colors[n][e]=layers.legends[n][0][3]),l>layers.legends[n][d-1][1]&&(layers.category_colors[n][e]=layers.legends[n][d-1][3]),null==l&&(layers.category_colors[n][e]="#fff")}s||(layers.category_colors[n][e]="#fff")}canvas.draw()},remove:function(e){var a=this;$.each(this.category,function(t,s){t>=e&&(a.category[t]=a.category[t+1])});for(var t=0;t<pointers.pointers.length;t++)for(var s=0;s<pointers.pointers[t].length;s++)pointers.pointers[t][s]==e&&(pointers.pointers[t][s]=0),pointers.pointers[t][s]>e&&(pointers.pointers[t][s]=parseInt(pointers.pointers[t][s])-1);this.category.pop(),this.show_list(),canvas.draw()},show_list:function(){for(var e="<table>",a="",t=this.category.length;t>1;t--)e+="<tr><td><span>"+(t-1)+'</span></td><td><input type="text" name="category_name" id_category="'+(t-1)+'" value="'+this.category[t-1][0]+'" /></td><td><div class="colorpicker_box" style="background-color:'+this.category[t-1][1]+'" id_category="'+(t-1)+'"></div></td><td><button class="remove" id_category="'+(t-1)+'">usun</button></td></tr>',a+='<option name="'+(t-1)+'">'+this.category[t-1][0]+"</option>";a+=0==menu_top.category?'<option selected name="0">'+this.category[0][0]+"</option>":'<option name="0">'+this.category[0][0]+"</option>",e+="</table>",$("#category_box #list").html(e),$("select#change_category").html(a),colorpicker.add()}};cloud={set_textarea:function(){$("#cloud .cloud_text").val(layers.cloud[layers.active])},set_position:function(){var e=mouse.left-on_category.canvas_offset_left,a=mouse.top-on_category.canvas_offset_top;$("#canvas_cloud").css({top:parseInt(a-$("#canvas_cloud").height()-30)+"px",left:e+"px"})},update_text:function(e){if(""!=e&&"null"!=e){for(var a=0,t=0,s=excel.data.length;t<s;t++)if(String(e).toLowerCase()==String(excel.data[t][layers.category[layers.active]]).toLowerCase()){this.set_position();for(var n=layers.cloud[layers.active],o=0,c=excel.data[0].length;o<c;o++)n=n.replace("{"+excel.data[0][o]+"}",excel.data[t][o]);""!=n&&($("#canvas_cloud").fadeIn(0),$("#canvas_cloud").html(n),a=1)}a||$("#canvas_cloud").fadeOut(0)}else $("#canvas_cloud").fadeOut(0)}};var colorpicker={row:null,col_num:null,add:function(){this.remove(),$(".colorpicker_box").ColorPicker({color:"#ff0000",onShow:function(e){return"none"==$(e).css("display")&&($(e).fadeIn(200),colorpicker.row=$(this).attr("row"),colorpicker.col_num=$(this).attr("col_num")),!1},onHide:function(e){return $(e).fadeOut(200),!1},onChange:function(e,a,t){$('#legends tr td[row="'+colorpicker.row+'"]').css("backgroundColor","#"+a),palets.color_arr[palets.color_arr.length-1]=palets.color_arr[layers.palets_active[layers.active]].slice(),palets.color_arr[palets.color_arr.length-1][colorpicker.col_num]="#"+a,layers.palets_active[layers.active]=palets.color_arr.length-1,layers.colors_active[layers.active][colorpicker.row]="#"+a,layers.legends[layers.active][colorpicker.row][3]="#"+a,palets.show(),categories.update_color()}})},remove:function(){$(".colorpicker").remove()}},crud={map_json:Array(),map_hash:null,layers:{},excel:Array(),project:{},project_hash:null,parse_data:function(){this.map_json=Array(),this.map_json[0]=Array(),this.map_json[0][0]=canvas.height_canvas,this.map_json[0][1]=canvas.width_canvas,this.map_json[0][2]=pointers.padding_x,this.map_json[0][3]=pointers.padding_y,this.map_json[0][4]=pointers.translate_modulo,this.map_json[0][5]=pointers.size,this.map_json[0][6]=pointers.main_kind,this.map_json[0][7]=canvas.title_project,this.map_json[1]=pointers.pointers,this.map_json[2]=categories.category,this.map_json[3]=Array(),image.obj&&(this.map_json[3][0]=image.obj.src,this.map_json[3][1]=image.x,this.map_json[3][2]=image.y,this.map_json[3][3]=image.width,this.map_json[3][4]=image.height,this.map_json[3][5]=image.alpha),this.layers.palets_active=layers.palets_active,this.layers.value=layers.value,this.layers.colors_pos=layers.colors_pos,this.layers.colors_active=layers.colors_active,this.layers.min_value=layers.min_value,this.layers.max_value=layers.max_value,this.layers.cloud=layers.cloud,this.layers.cloud_parser=layers.cloud_parser,this.layers.legends=layers.legends,this.layers.labels=layers.labels,this.layers.category=layers.category,this.layers.category_colors=layers.category_colors,this.layers.category_name=layers.category_name,this.layers.list=layers.list,this.project.name=layers.project_name,this.project.source=layers.source,this.excel=excel.data},publish:function(e){null!=crud.project_hash?(e||(e=window.event),"block"==$(".publish .embed").css("display")&&$(e.target).hasClass("publish")?$(".publish .embed").fadeOut(500):($(".publish .embed").html('<iframe width="100%" height="'+canvas.height_canvas+'px" border="0" frameborder="0" border="0" allowtransparency="true" vspace="0" hspace="0" src="http://'+location.href.split("/")[2]+"/embed/"+crud.project_hash+'"></iframe>'),$("#iframe").html('<iframe  onload="crud.publish_getSize(this)" width="100%" height="'+canvas.height_canvas+'px" border="0" frameborder="0" border="0" allowtransparency="true" vspace="0" hspace="0" src="http://'+location.href.split("/")[2]+"/embed/"+crud.project_hash+'"></iframe>'),$(".publish .embed").fadeIn(500))):alert("najpierw zapisz projekt a następnie go publikuj")},publish_getSize:function(e){console.log(e.contentWindow.document.body),console.log($(e.contentWindow.document.body).height(),$(e.contentWindow.document.body).width())},set_map:function(e){this.map_json=e,canvas.height_canvas=e[0][0],canvas.width_canvas=e[0][1],pointers.padding_x=e[0][2],pointers.padding_y=e[0][3],pointers.translate_modulo=e[0][4],pointers.size=e[0][5],pointers.main_kind=e[0][6],canvas.title_project=e[0][7],$('#pointer_box input[name="padding_x"]').val(e[0][2]),$('#pointer_box input[name="padding_y"]').val(e[0][3]),$('#pointer_box input[name="size"]').val(e[0][5]),$('input[name="title_project"]').val(e[0][7]),e[0][4]&&($('#pointer_box div[name="translate_modulo"]').removeClass("switch-off"),$('#pointer_box div[name="translate_modulo"]').addClass("switch-on")),$('#pointer_box select[name="main_kind"]').html(""),pointers.kinds.forEach(function(a){a==e[0][6]?$('#pointer_box select[name="main_kind"]').append('<option selected="selected" name="'+a+'">'+a+"</option>"):$('#pointer_box select[name="main_kind"]').append('<option name="'+a+'">'+a+"</option>")}),pointers.pointers=e[1],categories.category=e[2],layers.category_colors[0]=[],layers.category_name=[];for(var a=0,t=categories.category.length;a<t;a++)layers.category_name.push(categories.category[a][0]),layers.category_colors[0].push(categories.category[a][1]);e[3].length>2&&(image.obj=new Image,image.obj.src=e[3][0],image.x=parseInt(e[3][1]),image.y=parseInt(e[3][2]),image.width=parseInt(e[3][3]),image.height=parseInt(e[3][4]),image.alpha=parseInt(e[3][5]),$('#alpha_image option[name="'+image.alpha+'"]').attr("selected",!0),image.obj.onload=function(){canvas.draw()}),$("#main_canvas").attr("width",canvas.width_canvas+"px"),$("#main_canvas").attr("height",canvas.height_canvas+"px"),$("#canvas_box, #canvas_wrapper").css({width:canvas.width_canvas+"px",height:canvas.height_canvas+"px"}),canvas.draw(),categories.show_list()},set_project:function(e){this.set_map(JSON.parse(e.map_json)),excel.data=JSON.parse(e.excel),e.project=JSON.parse(e.project),e.layers=JSON.parse(e.layers),layers.palets_active=e.layers.palets_active,layers.value=e.layers.value,layers.colors_pos=e.layers.colors_pos,layers.colors_active=e.layers.colors_active,layers.min_value=e.layers.min_value,layers.max_value=e.layers.max_value,layers.cloud=e.layers.cloud,layers.cloud_parser=e.layers.cloud_parser,layers.legends=e.layers.legends,layers.labels=e.layers.labels,layers.category=e.layers.category,layers.category_colors=e.layers.category_colors,layers.category_name=e.layers.category_name,layers.list=e.layers.list,layers.project_name=e.project.name,layers.source=e.project.source,$('input[name="project_name"]').val(layers.project_name),tinyMCE.editors[0].setContent(layers.cloud[layers.active]),tinyMCE.editors[1].setContent(layers.source),excel.show(),palets.show(),legends.show(),layers.show(),labels.show()},get_map:function(){var e=this;$.ajax({url:"/api/map/"+e.map_hash,type:"GET",contentType:"application/json"}).done(function(a){e.set_map(JSON.parse(a.data[0].map_json))})},get_project:function(){var e=this;$.ajax({url:"/api/project/"+e.project_hash,type:"GET",contentType:"application/json"}).done(function(a){"ok"==a.status?e.set_project(a.data):(alert("nie udało się wczytać projektu"),console.log(a))})},create_project:function(){this.parse_data();var e=this,a={map_json:JSON.stringify(e.map_json),map_hash:e.map_hash,layers:JSON.stringify(e.layers),excel:JSON.stringify(e.excel),project:JSON.stringify(e.project)};jQuery.ajax({url:"api/projects",data:a,type:"POST",success:function(a){"ok"==a.status?(alert("zapisano nowy projekt"),e.project_hash=a.project_hash,menu_top.get_projects()):alert("błąd podczas zapisu")}})},update_project:function(){this.parse_data();var e=this,a={map_json:JSON.stringify(e.map_json),map_hash:e.map_hash,project_hash:e.project_hash,layers:JSON.stringify(e.layers),excel:JSON.stringify(e.excel),project:JSON.stringify(e.project)};jQuery.ajax({url:"api/projects",data:a,type:"PUT",success:function(e){"ok"==e.status?(menu_top.get_projects(),alert("zaktualizowano projekt")):(alert("błąd podczas aktualizacji"),console.log(e))}})},delete_project:function(){var e=this;null!=this.project_hash?jQuery.ajax({url:"api/project/"+e.project_hash,type:"DELETE",success:function(e){"ok"==e.status?location.reload():(alert("błąd podczas usuwania"),console.log(e))}}):alert("brak identyfikatora projektu")}},excel={alpha:["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","w","x","y","z"],data:[["","","","",""],["","","","",""],["","","","",""],["","","","",""],["","","","",""],["","","","",""],["","","","",""],["","","","",""],["","","","",""],["","","","",""],["","","","",""],["","","","",""]],min_row:12,min_col:6,init:function(){$("#excel_box button").click(function(){$("#excel_box input").click()}),$("#excel_box input").change(function(){excel.send_file()}),this.show()},show:function(){add_html="",excel.data.length>excel.min_row&&(excel.min_row=excel.data.length),excel.data[0].length>excel.min_col&&(excel.min_col=excel.data[0].length);for(var e=0;e<this.min_row;e++){add_html+='<tr class="tr">';for(var a=0;a<this.min_col;a++)if(0==a&&e>0)add_html+='<td class="td" row="'+e+'" col="'+a+'" >'+e+"</td>";else try{"undefined"!=typeof excel.data[e][a-1]?add_html+='<td class="td" contenteditable="true" row="'+e+'" col="'+a+'">'+excel.data[e][a-1]+"</td>":add_html+='<td class="td"  row="'+e+'" col="'+a+'"></td>'}catch(t){console.log(t,e,a),add_html+='<td class="td" row="'+e+'" col="'+a+'"></td>'}add_html+="</tr>"}$("#excel_box .table").html(add_html),$("#excel_box .table .td").keyup(function(){excel.edit(this)}),$("#excel_box .table .td").blur(function(){palets.show_select()})},edit:function(e){var a=$(e).html();$.isNumeric(a)&&(a=parseFloat(a)),excel.data[$(e).attr("row")][$(e).attr("col")-1]=a,categories.update_color()},send_file:function(){var e=new FormData;e.append("excel_file",$("#excel_box input")[0].files[0]),$.ajax({url:"/api/projects/excel_parse",type:"POST",data:e,processData:!1,contentType:!1}).done(function(e){console.log(e),excel.data=e.excel[0].data,excel.transition(),excel.show(),palets.show_select()})},transition:function(){for(var e=0,a=excel.data.length;e<a;e++)for(var t=0,s=excel.data[0].length;t<s;t++)excel.data[e][t]=$.trim(excel.data[e][t]),null==excel.data[e][t]&&(excel.data[e][t]=""),$.isNumeric(excel.data[e][t])&&(excel.data[e][t]=String(excel.data[e][t]).replace(".",","))}};excel.init();var figures={square:function(e,a,t){canvas.context.fillRect(e,a,t,t)},circle:function(e,a,t){var t=t/2,s=e+t,n=a+t;canvas.context.beginPath(),canvas.context.arc(s,n,t,0,2*Math.PI),canvas.context.fill()},hexagon:function(e,a,t){var s=t/4,n=t/2,o=t/2*Math.sqrt(3)/2;canvas.context.beginPath(),canvas.context.moveTo(e,a+n),canvas.context.lineTo(e+s,a+n-o),canvas.context.lineTo(e+s+n,a+n-o),canvas.context.lineTo(e+t,a+n),canvas.context.lineTo(e+t-s,a+n+o),canvas.context.lineTo(e+s,a+n+o),canvas.context.lineTo(e,a+n),canvas.context.fill()},hexagon2:function(e,a,t){var s=t/4,n=t/2,o=t/2*Math.sqrt(3)/2;canvas.context.beginPath(),canvas.context.moveTo(e+n,a),canvas.context.lineTo(e+n+o,a+s),canvas.context.lineTo(e+n+o,a+n+s),canvas.context.lineTo(e+n,a+t),canvas.context.lineTo(e+n-o,a+n+s),canvas.context.lineTo(e+n-o,a+s),canvas.context.lineTo(e+n,a),canvas.context.fill()}},global={toogle_panel:function(e){e||(e=window.event),parseInt($(e.target).parent().css("left"))>0?"0px"==$(e.target).parent().css("right")?$(e.target).parent().animate({right:[-$(e.target).parent().width()-20,"swing"]},1e3,function(){}):$(e.target).parent().animate({right:["0px","swing"]},1e3,function(){}):"0px"==$(e.target).parent().css("left")?$(e.target).parent().animate({left:[-$(e.target).parent().width()-20,"swing"]},1e3,function(){}):$(e.target).parent().animate({left:["0px","swing"]},1e3,function(){})}},image={obj:void 0,x:null,y:null,width:null,height:null,alpha:10,draw:function(){canvas.context.globalAlpha=this.alpha/10,canvas.context.drawImage(this.obj,this.x,this.y,this.width,this.height),$("#canvas_box #image_resize").css({height:this.height,top:this.y+"px",left:this.x+this.width+"px"}),canvas.context.globalAlpha=1},dataURItoBlob:function(e){for(var a=atob(e.split(",")[1]),t=[],s=0;s<a.length;s++)t.push(a.charCodeAt(s));return new Blob([new Uint8Array(t)],{type:"image/png"})}},data_input={get:function(){map.name=$('#map_form input[name="name"]').val(),map.path=$("#map_form textarea").val().replace(/"/g,"'"),$("#map_contener").html($("textarea[name=map_path]").val())},set:function(){$('#map_form input[name="name"]').val(map.name),$("#map_form textarea").val(map.path),$("#map_contener").html($("textarea[name=map_path]").val())}};labels={show:function(){$("#layers .label_layer").val(layers.labels[layers.active])},edit:function(e){layers.labels[layers.active]=$(e).val()}},$("#layers .label_layer").keyup(function(){labels.edit(this)});var layers={list:["zakładka 1"],active:0,palets_active:[0],value:[-1],colors_pos:[[1,1,1,1,1,1,1,1,1]],colors_active:[["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"]],min_value:[0],max_value:[0],cloud:[""],cloud_parser:[""],legends:[[]],labels:[""],category:[-1],category_colors:[],category_name:[],project_name:"nowy projekt",source:"",db_name:["list","palets_active","category","category_colors","category_name","value","colors_pos","colors_active","min_value","max_value","cloud","cloud_parser","legends","labels"],show:function(){for(var e="",a=0,t=this.list.length;a<t;a++)e+=a==this.active?'<span num="'+a+'" contenteditable="true" class="active">'+this.list[a]+"</span>":'<span num="'+a+'" contenteditable="true" >'+this.list[a]+"</span>";e+='<button class="add"> + </button><button class="remove"> - </button>',$("#layers > div").html(e),$("#layers .add").click(function(){layers.add()}),$("#layers .remove").click(function(){confirm("Czy chcesz usunąć warstwę ?")&&layers.remove()}),$("#layers span").click(function(){layers.select(this)}),$("#layers > div span").keyup(function(){layers.list[layers.active]=$(this).html()}),$("#layers > div span").dblclick(function(){$(this).addClass("contenteditable"),$(this).blur(function(){$(this).removeClass("contenteditable")})}),$("#layers > div").sortable({axis:"x",update:function(e,a){$("#layers > div span").each(function(e,a){if(e!=$(a).attr("num"))return layers.change_order($(a).attr("num"),e),!1})},cancel:".add,.remove,.contenteditable"})},select:function(e){$("#layers span").removeClass("active"),$(e).addClass("active"),layers.active=$(e).index(),tinyMCE.editors[0].setContent(layers.cloud[layers.active]),palets.show(),cloud.set_textarea(),labels.show(),legends.show(),canvas.draw()},change_order:function(e,a){for(var t=0,s=this.db_name.length;t<s;t++){var n=this[this.db_name[t]][a];this[this.db_name[t]][a]=this[this.db_name[t]][e],this[this.db_name[t]][e]=n}},add:function(){this.list.push("zakładka "+parseInt(this.list.length+1)),this.category.push(-1),this.category_colors.push(this.category_colors[this.category_colors.length-1].slice()),this.value.push(-1),this.palets_active.push(0),this.colors_active.push(["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"]),this.colors_pos.push([1,1,1,1,1,1,1,1,1]),this.min_value.push(0),this.max_value.push(0),this.cloud.push(""),this.cloud_parser.push(""),this.legends.push([]),this.labels.push(""),this.show()},remove:function(){if(this.active>0){if(this.active==this.list.length-1){var e=this.list.length-1;this.select($("#layers span").eq(e))}for(var a=this.active,t=layers.list.length-1;a<t;a++)for(var s=0,n=this.db_name.length;s<n;s++)this[this.db_name[s]][a]=this[this.db_name[s]][a+1];for(var o=layers.list.length-1,s=0,n=this.db_name.length;s<n;s++)this[this.db_name[s]].pop(),console.log(this[this.db_name[s]][o]);this.show(),this.select($("#layers span.active"))}}};$("#pointers .project_name").keyup(function(){layers.project_name=$(this).val()}),$.fn.selectText=function(){var e=document,a=this[0];if(e.body.createTextRange){var t=document.body.createTextRange();t.moveToElementText(a),t.select()}else if(window.getSelection){var s=window.getSelection(),t=document.createRange();t.selectNodeContents(a),s.removeAllRanges(),s.addRange(t)}},legends={show:function(){for(var e="<table><tr><th>kolor:</th><th>od:</th><th>do:</th><th>opis:</th></tr>",a=0,t=layers.legends[layers.active].length;a<t;a++)e+="<tr row='"+a+"'><td row='"+a+"' col_num='' style='background-color:"+layers.legends[layers.active][a][3]+"' class='color colorpicker_box'></td><td class='from' name='from' contenteditable='true'>"+layers.legends[layers.active][a][0]+"</td><td class='to' name='to' contenteditable='true'>"+layers.legends[layers.active][a][1]+"</td><td class='description' name='description' contenteditable='true'>"+layers.legends[layers.active][a][2]+"</td></tr>";e+="</table>",$("#legends").html(e);for(var s=1,a=0,t=layers.colors_pos[layers.active].length;a<t;a++)1==layers.colors_pos[layers.active][a]&&($("#legends table tr").eq(s).children("td").eq(0).attr("col_num",a),s++);if(18==layers.palets_active[layers.active]){for(var s=0,a=0,t=layers.colors_pos[layers.active].length;a<t;a++)1==layers.colors_pos[layers.active][a]?(palets.color_arr[18][a]=layers.colors_active[layers.active][s],s++):palets.color_arr[18][a]="#fff";palets.show()}colorpicker.add()},update:function(){var e=layers.colors_active[layers.active].length,a=Math.abs(layers.min_value[layers.active]-layers.max_value[layers.active]);layers.legends[layers.active]=[];for(var t=0,s=layers.colors_active[layers.active].length;t<s;t++){console.log(parseInt(layers.min_value[layers.active]),layers.min_value[layers.active]);var n=Math.round(100*(parseInt(layers.min_value[layers.active])+a/e*t))/100;if(t+1==s)var o=layers.max_value[layers.active];else var o=Math.round(100*(parseInt(layers.min_value[layers.active])+a/e*(t+1)-.01))/100;layers.legends[layers.active].push([n,o,String(n).replace(".",",")+" - "+String(o).replace(".",","),layers.colors_active[layers.active][t]])}this.show(),categories.update_color()},edit:function(e){var a=$(e).parent().attr("row"),t=$(e).attr("name"),s=$(e).html();switch(t){case"from":$.isNumeric(s)||$(e).html(parseFloat(s)),layers.legends[layers.active][a][0]=parseFloat(s),categories.update_color();break;case"to":$.isNumeric(s)||$(e).html(parseFloat(s)),layers.legends[layers.active][a][1]=parseFloat(s),categories.update_color();break;case"description":layers.legends[layers.active][a][2]=s}}},legends.show(),$("#legends").on("keyup","td",function(){legends.edit(this)});var eventMethod=window.addEventListener?"addEventListener":"attachEvent",eventer=window[eventMethod],messageEvent="attachEvent"==eventMethod?"onmessage":"message";eventer(messageEvent,function(e){console.log("parent received message!:  ",e.data)},!1),tinymce.init({menubar:!1,selector:".tinyedit",toolbar:"bold italic | link image",setup:function(e){e.on("change",function(a){var t=$(e.targetElm).attr("name");"cloud"==t&&(console.log(),layers.cloud[layers.active]=e.getContent()),"source"==t&&(layers.source=e.getContent())})}}),window.onbeforeunload=function(e){if("undefined"==typeof e&&(e=window.event),e&&!confirm("Czy chcesz opuścić tę stronę"))return!1},$(".box > ul > li").click(function(){menu_top.change_box(this)}),$(document).ready(function(){menu_top.get_maps(),menu_top.get_projects(),layers.show(),palets.show(),$(document).on("focusin","input",function(){menu_top.disable_select=!0}),$(document).on("focusout","input",function(){menu_top.disable_select=!1}),$(".publish .embed").click(function(){$(this).select()}),$(".publish").click(function(e){crud.publish(e)}),$("#toolbar_top button.save").click(function(){"string"==typeof crud.project_hash?crud.update_project():crud.create_project()}),$("#toolbar_top button.delete").click(function(){confirm("Czy chcesz usunąć projekt ?")&&crud.delete_project()}),$("#change_category").change(function(){$("#change_category").blur()}),$(document).mouseup(function(){mouse.mouse_down=!1}),$(document).mousedown(function(e){e||(e=window.event),mouse.set_mouse_down(e)}),$(document).mousemove(function(e){e||(e=window.event),mouse.set_position(e),mouse.mouse_down&&mouse.mousemove(e),menu_top.auto_draw&&(mouse.click_obj="canvas",mouse.mousemove(e))}),$("#main_canvas").mousedown(function(e){e||(e=window.event),mouse.set_mouse_down(e),mouse.set_position(e),mouse.mousemove(e)}),$(document).mouseup(function(){pointers.last_column=null,pointers.last_row=null,canvas.context_x=canvas.context_new_x,canvas.context_y=canvas.context_new_y}),$("#add_category").click(function(){categories.add()}),$('input[name="add_category"]').keypress(function(e){13==e.which&&categories.add()}),$("#excel_box h2, #pointer_box h2, #palets_box h2").click(function(e){global.toogle_panel(e)}),$("button.increment").click(function(){models.button_increment($(this))}),$("button.decrement").click(function(){models.button_decrement($(this))}),$(".switch").click(function(){models.update_from_switch($(this))}),$(".input_base").change(function(){models.update_from_input($(this))}),$(".input_base_text").change(function(){models.update_from_input_text($(this))}),$(".select_base").change(function(){models.update_from_select($(this))}),$("#menu_top #increment_canvas").click(function(){menu_top.increment_scale()}),$("#menu_top #decrement_canvas").click(function(){menu_top.decrement_scale()}),$("#menu_top #add_image").click(function(){menu_top.add_image()}),$("#menu_top #reset_canvas").click(function(){canvas.set_default()}),canvas.canvas=document.getElementById("main_canvas"),canvas.context=canvas.canvas.getContext("2d"),canvas.width_canvas=parseInt($("#main_canvas").attr("width")),canvas.height_canvas=parseInt($("#main_canvas").attr("height"));var e=$("#canvas_box").offset();canvas.offset_left=e.left,canvas.offset_top=e.top,pointers.create_array(),$("#canvas_info #width").val(canvas.width_canvas+"px"),$("#canvas_info #height").val(canvas.height_canvas+"px"),$("#canvas_box, #canvas_wrapper").css({width:canvas.width_canvas+"px",height:canvas.height_canvas+"px"}),$("#canvas_info #width,#canvas_info #height,#canvas_info #size").change(function(){menu_top.update_canvas_info()}),canvas.draw()}),menu_top={move_image:!1,move_canvas:!1,auto_draw:!1,mode_key:!0,category:0,disable_select:!1,change_box:function(e){$(e).parent().children("li").removeClass("active"),$(e).addClass("active");var a=$(e).attr("category");$(e).parent().parent().children("div").fadeOut(500,function(){$(e).parent().parent().children("#"+a).delay(100).fadeIn(500)})},get_maps:function(){$.ajax({url:"/api/maps",type:"GET",contentType:"application/json"}).done(function(e){if("ok"==e.status){for(var a='<option id="select_map">wybierz mapę</option>',t=0,s=e.data.length;t<s;t++)a+=e.data[t]._id==crud.map_hash?'<option selected id="'+e.data[t]._id+'">'+JSON.parse(e.data[t].map_json)[0][7]+"</option>":'<option id="'+e.data[t]._id+'">'+JSON.parse(e.data[t].map_json)[0][7]+"</option>";$("#toolbar_top select.select_map").html(a),$(".select_map").change(function(){"select_map"!=$(this).find("option:selected").attr("id")&&(null!=crud.map_hash?confirm("Czy chcesz wczytać nową mapę ?")&&(crud.map_hash=$(this).find("option:selected").attr("id"),crud.get_map()):($(".select_map option").eq(0).remove(),crud.map_hash=$(this).find("option:selected").attr("id"),crud.get_map()))})}else alert("nie mogę pobrać listy map"),console.log(e)})},get_projects:function(){$.ajax({url:"/api/projects",type:"GET",contentType:"application/json"}).done(function(e){if("ok"==e.status){for(var a='<option id="new_project">nowy projekt</option>',t=0,s=e.data.length;t<s;t++)a+=e.data[t]._id==crud.project_hash?'<option selected id="'+e.data[t]._id+'">'+JSON.parse(e.data[t].project).name+"</option>":'<option id="'+e.data[t]._id+'">'+JSON.parse(e.data[t].project).name+"</option>";$("#toolbar_top select.select_project").html(a),$(".select_project").change(function(){confirm("Czy chcesz wczytać nowy projekt ?")&&("new_project"==$(this).find("option:selected").attr("id")?location.reload():(crud.project_hash=$(this).find("option:selected").attr("id"),crud.get_project()))})}else alert("nie mogę pobrać listy projektów"),console.log(e)})},update_canvas_info:function(){canvas.scale=parseInt($("#canvas_info #size").val()),canvas.width_canvas=parseInt($("#canvas_info #width").val()),canvas.height_canvas=parseInt($("#canvas_info #height").val()),$("#canvas_info #size").val(canvas.scale+"%"),$("#canvas_info #width").val(canvas.width_canvas+"px"),$("#canvas_info #height").val(canvas.height_canvas+"px"),$("#canvas_box, #canvas_wrapper").css({width:canvas.width_canvas+"px",height:canvas.height_canvas+"px"}),$("#canvas_box #main_canvas").attr("width",canvas.width_canvas+"px"),$("#canvas_box #main_canvas").attr("height",canvas.height_canvas+"px"),canvas.draw()},change_alpha:function(){image.alpha=$("#alpha_image").find("option:selected").attr("name"),canvas.draw()},add_image:function(){var e=prompt("Podaj ścieżkę do zdjęcia: ");e&&e.length>0&&(image.obj=new Image,image.obj.onload=function(){image.width=image.obj.width,image.height=image.obj.height,image.draw()},image.x=0,image.y=0,image.obj.src=e)},show_info:function(){$("#canvas_info #size").val(parseInt(canvas.scale)+"%"),$("#canvas_info #width").val(parseInt(canvas.width_canvas)+"px"),$("#canvas_info #height").val(parseInt(canvas.height_canvas)+"px")}};var models={button_increment:function(e){var a=$(e).attr("nameinput"),t=parseInt($('input[name="'+a+'"]').val())+1;$('input[name="'+a+'"]').val(t),this.update_from_input($('input[name="'+a+'"]'))},button_decrement:function(e){var a=$(e).attr("nameinput"),t=parseInt($('input[name="'+a+'"]').val())-1;$('input[name="'+a+'"]').val(t),this.update_from_input($('input[name="'+a+'"]'))},update_from_input:function(e){var a=$(e).attr("obj"),t=$(e).attr("name");window[a][t]=parseInt($(e).val()),canvas.draw()},update_from_input_text:function(e){var a=$(e).attr("obj"),t=$(e).attr("name");window[a][t]=$(e).val(),canvas.draw()},update_from_select:function(e){var a=$(e).attr("obj"),t=$(e).attr("name");window[a][t]=$(e).find("option:selected").attr("name"),canvas.draw()},update_from_switch:function(e){var a=$(e).attr("obj"),t=$(e).attr("name");"false"==$(e).attr("value")?($(e).attr("value","true"),$(e).removeClass("switch-off"),$(e).addClass("switch-on"),window[a][t]=!0):($(e).attr("value","false"),$(e).removeClass("switch-on"),$(e).addClass("switch-off"),window[a][t]=!1),canvas.draw()}},mouse={mouse_down:!1,click_obj:null,tmp_mouse_x:null,tmp_mouse_y:null,left:null,top:null,padding_x:null,padding_y:null,offset_x:null,offset_y:null,set_mouse_down:function(e){e||(e=window.event);var a=e.target;if("undefined"!=typeof $(e.target).attr("nameclick")){this.click_obj=$(e.target).attr("nameclick");var t=$(a).offset();this.offset_x=t.left,this.offset_y=t.top,this.padding_x=this.left-t.left,this.padding_y=this.top-t.top,mouse.mouse_down=!0,this.tmp_mouse_x=image.x,this.tmp_mouse_y=image.y}},set_position:function(e){this.left=e.pageX,this.top=e.pageY},mousemove:function(){switch(this.click_obj){case"right_resize":var e=$("#canvas_box #canvas_wrapper").children("canvas").offset(),a=this.left-this.padding_x-e.left;a<screen.width-100&&canvas.resize_width(a),canvas.draw();break;case"bottom_resize":var e=$("#canvas_box #canvas_wrapper").children("canvas").offset();canvas.resize_height(this.top-this.padding_y-e.top),canvas.draw();break;case"image_resize":if(void 0!==image.obj){
var e=$("#canvas_box #canvas_wrapper").children("canvas").offset(),t=this.left-e.left,s=image.x+image.width-t+this.padding_x,n=image.width/image.height;image.width-s>100&&(image.width-=s,image.height-=s/n,canvas.draw())}}}},on_category={canvas_offset_top:187,canvas_offset_left:10,get_name:function(){var e=mouse.left-this.canvas_offset_left,a=mouse.top-this.canvas_offset_top,t=Math.ceil(a/(pointers.size+pointers.padding_y));if(pointers.translate_modulo&&t%2!=0)var s=Math.ceil((e+pointers.size/2)/(pointers.size+pointers.padding_x))-1;else var s=Math.ceil(e/(pointers.size+pointers.padding_x));try{var n=pointers.pointers[t-1][s-1],o=categories.category[n][0]}catch(c){return"null"}return"pusty"==o||"gumuj"==o?"null":o}};$("#canvas_wrapper").mouseleave(function(){$("#canvas_cloud").fadeOut(200)}),$("#canvas_wrapper").mousemove(function(){cloud.update_text(on_category.get_name())}),$("#canvas_cloud").mousemove(function(){cloud.set_position()});var palets={color_arr:[["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"],["#f7fcfd","#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#8c6bb1","#88419d","#810f7c","#4d004b"],["#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"],["#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0","#045a8d","#023858"],["#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636"],["#f7f4f9","#e7e1ef","#d4b9da","#c994c7","#df65b0","#e7298a","#ce1256","#980043","#67001f"],["#fff7f3","#fde0dd","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177","#49006a"],["#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"],["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"],["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"],["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"],["#ffffff","#f0f0f0","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525","#000000"],["#fff5eb","#fee6ce","#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704"],["#fcfbfd","#efedf5","#dadaeb","#bcbddc","#9e9ac8","#807dba","#6a51a3","#54278f","#3f007d"],["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d"],["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"]],show:function(){this.show_color(),this.show_palets(),this.show_select()},show_select:function(){add_html='<option col="-1">wybierz</option>';for(var e=0,a=excel.data[0].length;e<a;e++)""!=excel.data[0][e]&&(e==layers.category[layers.active]?add_html+='<option col="'+e+'" selected>'+excel.data[0][e]+"</option>":add_html+='<option col="'+e+'">'+excel.data[0][e]+"</option>");$("#excel_box select.category").html(add_html),add_html='<option col="-1">wybierz</option>';for(var e=0,a=excel.data[0].length;e<a;e++)""!=excel.data[0][e]&&(e==layers.value[layers.active]?add_html+='<option col="'+e+'" selected>'+excel.data[0][e]+"</option>":add_html+='<option col="'+e+'">'+excel.data[0][e]+"</option>");$("#excel_box select.value").html(add_html),$("#excel_wrapper .td").removeClass("value"),$("#excel_wrapper .td").removeClass("category"),layers.value[layers.active]!=-1&&$('#excel_wrapper .td[col="'+(layers.value[layers.active]+1)+'"]').addClass("value"),layers.category[layers.active]!=-1&&$('#excel_wrapper .td[col="'+(layers.category[layers.active]+1)+'"]').addClass("category")},set_category:function(e){layers.category[layers.active]=parseFloat($("#excel_box select.category option:selected").attr("col")),$("#excel_wrapper .td").removeClass("category"),$('#excel_wrapper .td[col="'+(layers.category[layers.active]+1)+'"]').addClass("category")},set_value:function(e){for(var a=parseFloat($("#excel_box select.value option:selected").attr("col")),t=!0,s=1,n=excel.data.length;s<n;s++)$.isNumeric(String(excel.data[s][a]).replace(",","."))||""==excel.data[s][a]||(t=!1,console.log("to nie jest liczba!: "+excel.data[s][a]));t?(layers.value[layers.active]=a,$("#excel_wrapper .td").removeClass("value"),$('#excel_wrapper .td[col="'+(layers.value[layers.active]+1)+'"]').addClass("value"),this.set_min_max_value()):(alert("wybrana kolumna zawiera wartości tekstowe"),this.show_select())},set_min_max_value:function(){var e=layers.value[layers.active];if(e!=-1){if(layers.value[e]!=-1)for(var a=String(excel.data[1][e]).replace(",","."),t=String(excel.data[1][e]).replace(",","."),s=1,n=excel.data.length;s<n;s++)a>String(excel.data[s][e]).replace(",",".")&&""!=excel.data[s][e]&&(a=String(excel.data[s][e]).replace(",",".")),t<String(excel.data[s][e]).replace(",",".")&&""!=excel.data[s][e]&&(t=String(excel.data[s][e]).replace(",","."));layers.min_value[layers.active]=a,layers.max_value[layers.active]=t,legends.update()}},show_color:function(){for(var e="",a=0,t=this.color_arr[0].length;a<t;a++)e+=1==layers.colors_pos[layers.active][a]?'<span class="active" style="background:'+this.color_arr[layers.palets_active[layers.active]][a]+'"></span>':'<span style="background:'+this.color_arr[layers.palets_active[layers.active]][a]+'"></span>';$("#palets #select").html(e),$("#palets #select > span").click(function(){palets.select_color(this)})},show_palets:function(){for(var e="",a=0,t=this.color_arr.length;a<t;a++){e+=a==layers.palets_active[layers.active]?'<span class="active">':"<span>";for(var s=0,n=this.color_arr[0].length;s<n;s++)e+='<span style="background:'+this.color_arr[a][s]+'"></span>';e+="</span>"}$("#palets #all").html(e),$("#palets #all > span").click(function(){palets.select_palets(this)})},select_color:function(e){layers.value[layers.active]!=-1&&layers.category[layers.active]!=-1&&($(e).hasClass("active")?(layers.colors_pos[layers.active][$(e).index()]=0,$(e).removeClass("active")):(layers.colors_pos[layers.active][$(e).index()]=1,$(e).addClass("active")),this.parse_color(),palets.set_min_max_value())},parse_color:function(){function e(e){function a(e){return("0"+parseInt(e).toString(16)).slice(-2)}return e=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),"#"+a(e[1])+a(e[2])+a(e[3])}layers.colors_active[layers.active]=[];for(var a=0,t=this.color_arr[0].length;a<t;a++)$("#palets #select span").eq(a).hasClass("active")&&layers.colors_active[layers.active].push(e($("#palets #select span").eq(a).css("background-color")));legends.update()},select_palets:function(e){if(layers.value[layers.active]!=-1&&layers.category[layers.active]!=-1){$("#palets #all > span").removeClass("active"),$(e).addClass("active"),layers.palets_active[layers.active]=$(e).index(),layers.colors_active[layers.active]=[];for(var a=0,t=layers.colors_pos[layers.active].length;a<t;a++)1==layers.colors_pos[layers.active][a]&&layers.colors_active[layers.active].push(palets.color_arr[layers.palets_active[layers.active]][a]);for(var a=0,t=layers.legends[layers.active].length;a<t;a++)layers.legends[layers.active][a][3]=layers.colors_active[layers.active][a];palets.show_color(),legends.show(),categories.update_color()}}};$("#excel_box select.category").change(function(){palets.set_category(this)}),$("#excel_box select.value").change(function(){palets.set_value(this)});var pointers={show_all_point:!0,padding_x:1,padding_y:1,translate_modulo:!1,size:10,main_kind:"square",kinds:Array("square","circle","hexagon","hexagon2"),pointers:Array(),last_column:null,last_row:null,draw:function(){var e=this.size+this.padding_x,a=this.size+this.padding_y,t="rgba(0,0,0,0)";this.show_all_point&&(t="rgba(128,128,128,1)");for(var s=0;s<canvas.active_row;s++)for(var n=0;n<canvas.active_column;n++){if(0==this.pointers[s][n])canvas.context.fillStyle=t,canvas.context.globalAlpha=.5;else{this.pointers[s][n]!=menu_top.category&&0!=menu_top.category?canvas.context.globalAlpha=.2:canvas.context.globalAlpha=1;try{canvas.context.fillStyle=layers.category_colors[layers.active][this.pointers[s][n]]}catch(o){console.log("ERROR 39 LINE ! ",this.pointers[s][n],s,n)}}s%2==0&&pointers.translate_modulo?window.figures[this.main_kind](n*e+e/2,s*a,this.size):window.figures[this.main_kind](n*e,s*a,this.size)}},create_array:function(){if(canvas.active_row=parseInt(canvas.height_canvas/(pointers.size+pointers.padding_y)),canvas.active_column=parseInt(canvas.width_canvas/(pointers.size+pointers.padding_x)),this.pointers.length<canvas.active_row||this.pointers[0].length<canvas.active_column)for(var e=0;e<canvas.active_row;e++)for(var a=0;a<canvas.active_column;a++)void 0==this.pointers[e]&&(this.pointers[e]=new Array),void 0==this.pointers[e][a]&&(this.pointers[e][a]=0)},update_point:function(e,a,t,s){if(this.pointers[e][a]=parseInt(menu_top.category),t==e&&s==a||null==t||null==s)this.pointers[e][a]=parseInt(menu_top.category);else{var n=(t-e)/(s-a),o=e-n*a;if(s>a)var c=a,r=s;else var r=a,c=s;if(t>e)var l=e,i=t;else var i=e,l=t;for(var d=null,p=c;p<=r;p++)d=parseInt(n*p+o),$.isNumeric(d)||(d=e),this.pointers[d][p]=parseInt(menu_top.category);for(var p=null,d=l;d<=i;d++)p=parseInt((d-o)/n),$.isNumeric(p)||(p=a),this.pointers[d][p]=parseInt(menu_top.category)}}};